<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.project.service.proxy.CommodityProxy">
	<select id="typeList" resultType="java.util.Map">
		SELECT
			commodity_type_id typeId,
			commodity_type_name typeName
		FROM
			commodity_type
		WHERE
			del_flag = 1
		AND status = 1
		ORDER BY
			sort
	</select>
	
	<select id="listOfType" resultType="java.util.Map">
		SELECT
			commodity_info_id commodityId,
			commodity_title commodityTitle,
			commodity_synopsis commoditySynopsis,
			commodity_price commodityProce,
			commodity_cover_path coverPath
		FROM
			commodity_info
		WHERE
			commodity_type_id = #{typeId}
		AND commodity_title LIKE CONCAT('%', #{searchKey}, '%')
		AND del_flag = 1
		AND status = 1
	</select>
	
	<select id="info" resultType="java.util.Map">
		SELECT
			commodity_info_id commodityId,
			commodity_title commodityTitle,
			commodity_synopsis commoditySynopsis,
			commodity_price commodityProce,
			rotation_chart_paths rotationChartPaths,
			commodity_content commodityContent,
			(
				SELECT
					IFNULL(SUM(total), 0)
				FROM
					commodity_order
				WHERE
					commodity_info_id = commodity_info.commodity_info_id
				AND STATUS != 1
			) totalBuy
		FROM
			commodity_info
		WHERE
			commodity_info_id = #{commodityId}
		AND del_flag = 1
		AND status = 1
	</select>
	
	<insert id="buy" useGeneratedKeys="true" keyProperty="user.tempId">
		INSERT commodity_order (
			commodity_info_id,
			order_number,
			total,
			one_price,
			order_price,
			pay_type,
			receive_user_name,
			receive_user_tel,
			receive_address,
			user_id
		)
		SELECT 
			a.*,b.*,#{user.userId}
		FROM 
			(
				SELECT
					a.commodity_info_id,
					IFNULL((
						SELECT
							CONCAT(DATE_FORMAT(NOW(),'%Y%m%d'),LPAD(SUBSTR(MAX(order_number) FROM 9) +1,5,'0'))
						FROM
							commodity_order
						WHERE
							commodity_info_id = a.commodity_info_id
						AND DATE(create_time) = DATE(NOW())
					),CONCAT(DATE_FORMAT(NOW(),'%Y%m%d'),LPAD(1,5,'0'))),
					#{total} total,
					a.commodity_price,
					(a.commodity_price * #{total}) order_price,
					#{payType} payType
				FROM
					commodity_info a
				WHERE
					a.commodity_info_id = #{commodityId}
			) a
			LEFT JOIN (
				SELECT
					receive_user_name,
					receive_user_tel,
					CONCAT(province_name,city_name,district_name,receive_address)
				FROM
					user_receive_info
				WHERE
					user_receive_info_id = #{receiveId}
				AND user_id = #{user.userId}
			) b ON 1 = 1
	</insert>
	
	<update id="update">
		UPDATE 
			commodity_order
		SET 
			status = #{status}
		WHERE
			commodity_order_id = #{orderId}
	</update>
</mapper>